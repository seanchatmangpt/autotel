# Makefile for SHACL-AOT 80/20 Benchmark

CC = clang
CFLAGS = -O3 -march=native -Wall -Wextra -I./include -I.
LDFLAGS = -lm

# Platform detection
UNAME_S := $(shell uname -s)
UNAME_M := $(shell uname -m)

# Architecture-specific optimizations
ifeq ($(UNAME_M),x86_64)
    CFLAGS += -mavx2 -msse4.2
else ifeq ($(UNAME_M),arm64)
    CFLAGS += -mcpu=native
endif

# Source files
BENCHMARK_SRC = shacl_aot_80_20_benchmark.c
CNS_SRCS = src/engines/sparql.c src/engines/shacl.c src/cns_parser.c

# Object files
CNS_OBJS = $(CNS_SRCS:.c=.o)

# Target
TARGET = shacl_80_20_benchmark

.PHONY: all clean benchmark

all: $(TARGET)

$(TARGET): $(BENCHMARK_SRC) $(CNS_OBJS)
	$(CC) $(CFLAGS) -o $@ $(BENCHMARK_SRC) $(CNS_OBJS) $(LDFLAGS)

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

benchmark: $(TARGET)
	@echo "ðŸš€ Running SHACL-AOT 80/20 Benchmark..."
	@echo "============================================"
	./$(TARGET) 10000

clean:
	rm -f $(TARGET) $(CNS_OBJS)

# Quick test with fewer iterations
test: $(TARGET)
	./$(TARGET) 1000

# Performance profiling
profile: $(TARGET)
	@echo "ðŸ“Š Profiling with 100,000 iterations..."
	./$(TARGET) 100000