# Standalone Gatekeeper Test Makefile

CC = clang
CFLAGS = -O3 -march=native -Wall -Wextra -std=c11 -lm -g
INCLUDES = -Iinclude

# Test targets
TEST_SRC = tests/test_gatekeeper_standalone.c
TEST_TARGET = test_gatekeeper_standalone

# Default target
all: $(TEST_TARGET)

# Build test executable
$(TEST_TARGET): $(TEST_SRC)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $<
	@echo "✓ Built $(TEST_TARGET)"

# Run unit tests
test: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone unit tests..."
	./$(TEST_TARGET)

# Run tests with verbose output
test-verbose: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone unit tests with verbose output..."
	./$(TEST_TARGET) 2>&1 | tee test_results_standalone.log

# Run performance benchmarks
bench: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone performance benchmarks..."
	time ./$(TEST_TARGET)

# Run memory check
memcheck: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone with memory check..."
	valgrind --leak-check=full --show-leak-kinds=all ./$(TEST_TARGET)

# Run with sanitizers
sanitize: CFLAGS += -fsanitize=address -fsanitize=undefined
sanitize: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone with sanitizers..."
	./$(TEST_TARGET)

# Coverage build
coverage: CFLAGS += -fprofile-arcs -ftest-coverage
coverage: $(TEST_TARGET)
	@echo "Running Gatekeeper standalone with coverage..."
	./$(TEST_TARGET)
	@echo "Coverage data generated"

# Clean
clean:
	rm -f $(TEST_TARGET)
	rm -f *.gcno *.gcda *.gcov
	rm -f test_results_standalone.log
	@echo "✓ Cleaned standalone test artifacts"

# Install test dependencies
deps:
	@echo "Installing test dependencies..."
	@which valgrind > /dev/null || echo "Warning: valgrind not found (install for memory checking)"
	@which gcov > /dev/null || echo "Warning: gcov not found (install for coverage)"

# Help
help:
	@echo "Gatekeeper Standalone Test Makefile targets:"
	@echo "  make test        - Run unit tests"
	@echo "  make test-verbose - Run tests with verbose output"
	@echo "  make bench       - Run performance benchmarks"
	@echo "  make memcheck    - Run with memory checking"
	@echo "  make sanitize    - Run with sanitizers"
	@echo "  make coverage    - Run with coverage analysis"
	@echo "  make clean       - Clean test artifacts"
	@echo "  make deps        - Check test dependencies"

.PHONY: all test test-verbose bench memcheck sanitize coverage clean deps help 